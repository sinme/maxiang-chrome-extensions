/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function TagSelector(a,b,c){"use strict";function d(){var a=document.activeElement===C;return C.innerText="",C.blur(),a}function e(a){g(x,a)}function f(a){g(y,a)}function g(a,b){for(var c=0;c<b.length;c++)for(var d=new Tag(b[c].name),e=b[c].name.split(/\s+/),f=0;f<e.length;f++)if(d.paths.indexOf(e[f])<0&&d.paths.push(e[f]),a.insert(e[f],d),CommonSelector.SPECIAL_CHAR_REGEX.test(e[f])){var g=e[f].replace(CommonSelector.SPECIAL_CHAR_REGEX,"");d.paths.indexOf(g)<0&&d.paths.push(g),a.insert(g,d)}}function h(a){if(void 0!==a&&a.length>v&&(a=a.substr(0,v)),D.children.length<u&&""!==a&&!A[a.toLowerCase()]){var b=document.createElement("div");b.innerText=a;var c=document.createElement("div");c.classList.add("tTag"),c.title=a,b.classList.add("tTagText");var d=document.createElement("div");d.classList.add("tDeleteTag"),d.addEventListener("click",function(){k(this.parentNode)}),c.appendChild(d),c.appendChild(b),D.appendChild(c),D.children.length>=u&&l(w.EXCEEDED_MAX),o(),A[a.toLowerCase()]=1}}function i(a){h(a.trim()),C.innerHTML="",s(null,"")}function j(a){var b=document.createElement("div");b.innerText=a,b.title=a,b.classList.add("tDropdownTag"),b.addEventListener("mouseover",function(){for(var a=E.querySelectorAll(".tHover"),b=0;b<a.length;b++)a[b].classList.remove("tHover");this.classList.add("tHover")}),b.addEventListener("mousedown",function(a){1===a.which&&i(this.innerText),a.preventDefault()}),CommonSelector.binaryInsert(E,function(a){return a.innerText},b),B[a]=1}function k(a){delete A[a.lastElementChild.innerText.toLowerCase()],a.parentNode.removeChild(a),D.children.length<u&&m(),o(),c()}function l(a){C.classList.add("tDisabled"),C.contentEditable="false",a===w.EXCEEDED_MAX?C.classList.add("tMax"):a===w.LINKED_NOTEBOOK&&(C.classList.add("tLinked"),D.style.display="none"),c()}function m(){C.classList.remove("tDisabled","tMax","tLinked"),C.contentEditable="true",D.style.display="",c()}function n(){var a=[];if(!C.classList.contains("tDisabled")||!C.classList.contains("tLinked"))for(var b=0;b<D.children.length;b++)a.push(GlobalUtils.removeControlCharacters(D.children[b].lastElementChild.innerText));return a}function o(){for(var a=0,b=D.children.length-1;b>=0;b--)if(a||(a=D.children[b].offsetTop),D.children[b].offsetTop===a)D.children[b].classList.add("lastRow");else{if(!D.children[b].classList.contains("lastRow"))break;D.children[b].classList.remove("lastRow")}}function p(){C.focus()}function q(a,b){for(var c=a.join(" "),d=0;d<b.length;d++)if(!new RegExp("(\\s|^)"+b[d].replace(/([\\\^\$\.\|\?\*\+\(\)\[\{\]\}])/g,"\\$1"),"i").test(c))return!1;return!0}function r(){x=new Trie,y=new Trie,z=null}function s(a,c){if(E.innerHTML="",B={},a&&""!==c.trim())for(var d=c.split(/\s+/),e=a.getMatching(d[0],75),f=0;f<e.length;f++)for(var g=0;g<e[f][1].length;g++)A[e[f][1][g].name.toLowerCase()]||B[e[f][1][g].name]||!q(e[f][1][g].paths,d)||j(e[f][1][g].name);b()}function t(a){m(),D.children.length>=u&&l(w.EXCEEDED_MAX),a===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?z=x:a===GlobalUtils.NOTEBOOK_TYPE_LINKED?l(w.LINKED_NOTEBOOK):a===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(z=y)}var u=20,v=100,w={EXCEEDED_MAX:1,LINKED_NOTEBOOK:2},x=new Trie,y=new Trie,z=null,A={},B={};a.classList.add("tContainer");var C=document.createElement("div");C.classList.add("tInput"),C.dataset.placeholder=Browser.i18n.getMessage("quickNote_addTags"),C.dataset.maxTagsPlaceholder=Browser.i18n.getMessage("tagNamesNotInRange"),C.dataset.linkedPlaceholder=Browser.i18n.getMessage("quickNote_tagsDisabled"),C.tabIndex=3;var D=document.createElement("div");D.classList.add("tExisting");var E=document.createElement("div");E.classList.add("tDropdown"),m(),C.addEventListener("input",function(){C.innerText=C.innerText,C.innerText=C.innerText.replace(/\n/g,"");var a=C.innerText.split(/\s*,\s*/);if(a.length>1)for(var b=0;b<a.length;b++)i(a[b]);else s(z,C.innerText)}),C.addEventListener("blur",function(){i(C.innerText)}),C.addEventListener("keydown",function(a){if(13===a.keyCode){var b=E.querySelector(".tHover");i(b?b.innerText:C.innerText)}else if(["Up","Down"].indexOf(a.keyIdentifier)>=0){var b=E.querySelector(".tHover");if(b){var c=null;c="Up"===a.keyIdentifier?b.previousElementSibling:b.nextElementSibling}else c=E.firstElementChild;c&&(c.classList.add("tHover"),b&&b.classList.remove("tHover"),c.scrollIntoViewIfNeeded()),a.preventDefault()}}),E.addEventListener("mousedown",function(a){a.preventDefault()}),a.appendChild(C),a.appendChild(D),a.appendChild(E),this.abort=d,this.addBusinessTags=f,this.addPersonalTags=e,this.addTagAndClearInput=i,this.focus=p,this.getTags=n,this.reset=r,this.setActiveTrie=t,this.__defineGetter__("height",function(){return E.offsetTop+E.offsetHeight}),Object.preventExtensions(this)}function Tag(a){"use strict";this.name=a,this.paths=[],Object.preventExtensions(this)}Object.preventExtensions(TagSelector),Object.preventExtensions(Tag);